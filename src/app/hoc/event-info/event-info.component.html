<div class="details-wrapper">
  <mat-card *ngIf="isLocked" class="read-only-view">
    <div class="info-grid">
      <div class="info-item">
        <span class="label"> Details </span>

        <span class="value">
          <p>
            <span class="icon"><mat-icon>person</mat-icon></span>
            <span class="text">{{ form.get("clientName")?.value }}</span>
          </p>

          <p>
            <span class="icon"><mat-icon>phone</mat-icon></span>
            <span class="text"
              >{{ form.get("countryCode")?.value }}
              {{ form.get("phone")?.value }}</span
            >
          </p>

          <p>
            <span class="icon"><mat-icon>event</mat-icon></span>
            <span class="text"
              >{{ form.get("date")?.value | date : "mediumDate" }} |
              {{ form.get("entry")?.value }}</span
            >
          </p>

          <p>
            <span class="icon"><mat-icon>place</mat-icon></span>
            <span class="text"
              >{{ form.get("venue")?.value || "--" }},
              {{ form.get("location")?.value || "--" }}</span
            >
          </p>
        </span>
      </div>

      <div class="info-item full-width">
        <span class="label">Notes</span>
        <span class="value">{{
          form.get("notes")?.value || "No notes added."
        }}</span>
      </div>
    </div>

    <div class="actions">
      <button
        mat-stroked-button
        color="primary"
        type="button"
        (click)="unlockForm()"
      >
        <mat-icon>lock_open</mat-icon> Unlock to Edit
      </button>
    </div>
  </mat-card>

  <form [formGroup]="form" class="form" *ngIf="!isLocked">
    <mat-card>
      <mat-label> Confirmed </mat-label>
      <mat-slide-toggle formControlName="confirmed" class="mat-slide-toggle">
      </mat-slide-toggle>
    </mat-card>

    <mat-form-field appearance="outline">
      <mat-label>Date</mat-label>
      <input matInput [matDatepicker]="picker" formControlName="date" />
      <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
      <mat-datepicker #picker></mat-datepicker>
      <mat-error *ngIf="form.get('date')?.hasError('required')"
        >Date is required</mat-error
      >
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Client Name</mat-label>
      <input matInput formControlName="clientName" />
      <mat-error *ngIf="form.get('clientName')?.hasError('required')"
        >Client name is required</mat-error
      >
    </mat-form-field>

    <mat-form-field appearance="outline" class="country-code">
      <mat-label>Code</mat-label>
      <mat-select formControlName="countryCode">
        <mat-option *ngFor="let c of countryCodes" [value]="c.code">
          {{ c.label }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline" class="phone-input">
      <mat-label>Phone Number</mat-label>
      <input
        matInput
        type="tel"
        inputmode="numeric"
        formControlName="phone"
        placeholder="XXXXXXXXXX"
        maxlength="10"
      />

      <mat-error *ngIf="form.get('phone')?.hasError('required')">
        Phone number is required
      </mat-error>

      <mat-error *ngIf="form.get('phone')?.hasError('pattern')">
        Enter valid 10-digit number
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Venue</mat-label>
      <input matInput formControlName="venue" />
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Entry</mat-label>
      <mat-select formControlName="entry">
        <mat-option value="Morning">Morning</mat-option>
        <mat-option value="Noon">Noon</mat-option>
        <mat-option value="Evening">Evening</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Location</mat-label>
      <input matInput formControlName="location" />
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Quoted Amount</mat-label>
      <input matInput formControlName="quotedAmount" type="number" />
      <span matTextPrefix>Rs&nbsp;</span>
    </mat-form-field>

    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Notes</mat-label>
      <textarea matInput formControlName="notes"></textarea>
    </mat-form-field>

    <!-- toggle button for confirmed or not -->
    <br />
    <div class="actions">
      <button mat-button type="button" (click)="onCancel()">Cancel</button>
      <button mat-raised-button color="primary" (click)="submit()">Save</button>
    </div>
  </form>

  <mat-card class="bill-card">
    <mat-card-header>
      <mat-card-title>Financial Summary</mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <div class="stats-grid">
        <!-- Profit and Expense above progress bar -->
        <div class="stats-row">
          <div class="stat-item">
            <span class="stat-label">Estimated Profit</span>
            <span
              class="stat-value"
              [ngClass]="calculateProfit() >= 0 ? 'profit' : 'loss'"
            >
              <span
                class="stat-value"
                [ngClass]="calculateProfit() >= 0 ? 'profit' : 'loss'"
              >
                {{ calculateProfit() | currency : "INR" : "symbol" : "1.0-0" }}
                <span class="percentage"
                  >({{ calculateMargin() | number : "1.0-0" }}%)</span
                >
              </span>
            </span>
          </div>

          <div class="stat-item">
            <span class="stat-label">Total Expense</span>
            <span class="stat-value expense">
              {{ totalExpense | currency : "INR" : "symbol" : "1.0-0" }}
            </span>
          </div>
        </div>

        <!-- Progress bar -->
        <mat-progress-bar
          #matProgressBar
          mode="determinate"
          [value]="calculateMargin()"
          [color]="calculateProfit() >= 0 ? 'primary' : 'warn'"
        >
        </mat-progress-bar>

        <!-- Quoted amount below progress bar -->
        <div class="quoted-section">
          <span class="stat-label">Quoted Amount</span>
          <span class="stat-value quoted">
            {{
              form.value.quotedAmount || 0
                | currency : "INR" : "symbol" : "1.0-0"
            }}
          </span>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
</div>
